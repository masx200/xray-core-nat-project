# 双向NAT功能使用说明

## 概述

基于我们实现的双向NAT功能，站点A和站点B可以通过虚拟IP地址实现互通，解决物理IP地址冲突问题。

## 网络架构

### 站点A配置
- **真实网络**: `192.168.1.0/24` 和 `10.10.10.0/24`
- **虚拟网络**: `240.1.1.0/24` 和 `64:FF9B:1111::/96`
- **监听端口**: 10808 (SOCKS5), 10809 (HTTP)
- **站点ID**: `site-a`

### 站点B配置
- **真实网络**: `192.168.1.0/24` 和 `10.20.20.0/24`
- **虚拟网络**: `240.2.2.0/24` 和 `64:FF9B:2222::/96`
- **监听端口**: 10808 (SOCKS5), 10809 (HTTP)
- **站点ID**: `site-b`

## 部署步骤

### 1. 编译支持NAT功能的Xray

```bash
cd Xray-core-main
go build -o xray-nat -trimpath -buildvcs=false -ldflags="-s -w -buildid=" -v ./main
```

### 2. 复制配置文件

将配置文件复制到各个站点：

**站点A:**
```bash
cp site-a-config.json /etc/xray/config.json
cp xray-nat /usr/local/bin/xray
```

**站点B:**
```bash
cp site-b-config.json /etc/xray/config.json
cp xray-nat /usr/local/bin/xray
```

### 3. 启动服务

**站点A:**
```bash
xray -c /etc/xray/config.json
```

**站点B:**
```bash
xray -c /etc/xray/config.json
```

### 4. 验证服务状态

检查服务是否正常启动：
```bash
# 检查端口监听
netstat -tlnp | grep 1080

# 检查日志
tail -f /var/log/xray/access.log
```

## 使用方法

### 场景1：站点A访问站点B的服务

**站点A的电脑C (192.168.1.20)** 访问 **站点B的电脑D (192.168.1.20)**

1. **配置客户端代理**
   ```bash
   # 使用SOCKS5代理
   export ALL_PROXY=socks5://站点A路由器IP:10808

   # 或者使用HTTP代理
   export http_proxy=http://站点A路由器IP:10809
   export https_proxy=http://站点A路由器IP:10809
   ```

2. **访问虚拟IP地址**
   ```bash
   # 站点A的电脑C访问站点B电脑D的虚拟IP
   curl http://240.2.2.20
   ping 240.2.2.20
   ```

3. **使用IPv6虚拟地址**
   ```bash
   # 使用IPv6嵌入式IPv4地址
   curl http://[64:FF9B:2222::192.168.1.20]
   ping 64:FF9B:2222::192.168.1.20
   ```

### 场景2：站点B访问站点A的服务

**站点B的电脑D (192.168.1.20)** 访问 **站点A的电脑C (192.168.1.20)**

1. **配置客户端代理**
   ```bash
   export ALL_PROXY=socks5://站点B路由器IP:10808
   ```

2. **访问虚拟IP地址**
   ```bash
   # 站点B的电脑D访问站点A电脑C的虚拟IP
   curl http://240.1.1.20
   ping 240.1.1.20
   ```



## 配置文件说明

### NAT Outbound配置

```json
{
  "protocol": "nat",
  "settings": {
    "siteId": "site-a",                    // 站点标识
    "virtualRanges": [                       // 虚拟IP范围映射
      {
        "virtualNetwork": "240.1.1.0/24",
        "realNetwork": "192.168.1.0/24",
        "ipv6Enabled": true,
        "ipv6Prefix": "64:FF9B:1111::/96"
      }
    ],
    "rules": [                             // NAT转换规则
      {
        "ruleId": "to-site-b",
        "sourceSite": "site-b",            // 源站点过滤
        "virtualDestination": "240.2.2.0/24",
        "realDestination": "192.168.1.0/24",
        "protocol": "tcp,udp"
      }
    ]
  }
}
```

### 路由规则配置

```json
{
  "routing": {
    "rules": [
      {
        "type": "field",
        "ip": ["240.2.2.0/24"],              // 目标虚拟IP段
        "outboundTag": "nat-outbound"         // 使用NAT出站
      }
    ]
  }
}
```

## 验证连接

### 1. 检查NAT会话

```bash
# 在站点A路由器上查看会话
curl http://127.0.0.1:8080/stats -H "Content-Type: application/json"
```

### 2. 测试连通性

```bash
# 站点A测试到站点B的虚拟IP
ping 240.2.2.20
curl http://240.2.2.20:80

# 站点B测试到站点A的虚拟IP
ping 240.1.1.20
curl http://240.1.1.20:80
```

### 3. 验证双向通信

```bash
# 在站点A的电脑C上启动一个简单的HTTP服务
python3 -m http.server 8000

# 在站点B的电脑C上访问站点A电脑C的虚拟IP
curl http://240.1.1.20:8000
```

## 故障排除

### 常见问题

1. **连接超时**
   - 检查防火墙设置
   - 确认Zero Trust网络连通性
   - 验证虚拟IP配置是否正确

2. **NAT转换不工作**
   - 检查siteId配置是否匹配
   - 验证virtualRanges配置
   - 查看Xray日志中的错误信息

3. **代理连接失败**
   - 检查inbound配置
   - 验证端口是否被占用
   - 检查认证设置

### 日志分析

```bash
# 查看详细日志
tail -f /var/log/xray/access.log

# 查看错误日志
journalctl -u xray -f
```

### 配置验证

```bash
# 验证配置文件语法
xray -test -c /etc/xray/config.json

# 检查NAT配置
curl http://127.0.0.1:8080/debug/httponly
```

## 高级配置

### 端口映射

如果需要端口映射，可以在NAT规则中添加：

```json
{
  "ruleId": "port-mapping",
  "virtualDestination": "240.2.2.20",
  "realDestination": "192.168.1.20",
  "protocol": "tcp",
  "portMapping": {
    "originalPort": "8080",
    "translatedPort": "80"
  }
}
```

### 资源限制调整

根据服务器资源调整限制：

```json
{
  "resourceLimits": {
    "maxSessions": 10000,           // 最大会话数
    "maxMemoryMB": 100,             // 最大内存使用(MB)
    "cleanupThreshold": 0.8        // 清理阈值
  }
}
```

## 性能优化

### 会话超时调整

```json
{
  "sessionTimeout": {
    "tcpTimeout": 300,               // TCP会话超时(秒)
    "udpTimeout": 60,                // UDP会话超时(秒)
    "cleanupInterval": 30            // 清理间隔(秒)
  }
}
```

### 监控指标

启用API进行监控：

```json
{
  "api": {
    "tag": "api",
    "services": ["StatsService", "RoutingService"]
  }
}
```

## 安全注意事项

1. **访问控制**
   - 使用防火墙限制访问
   - 配置SOCKS5认证
   - 定期审计访问日志

2. **网络安全**
   - 启用TLS加密
   - 定期更新Xray版本
   - 监控异常连接

3. **资源保护**
   - 设置合理的会话限制
   - 监控内存使用
   - 配置适当的清理策略

## 总结

通过这个双向NAT实现，两个具有IP地址冲突的站点可以通过虚拟IP地址实现完全互通。用户只需要配置代理并使用虚拟IP地址，底层的地址转换由Xray的NAT功能自动处理。

这种方案的优势：
- 不需要修改现有网络设备配置
- 对终端用户透明
- 支持多种协议(TCP/UDP)
- 提供IPv4和IPv6双重支持
- 具备良好的扩展性和可维护性