

# 开放规范提案：实现双向 NAT

## 概述

本提案概述了为 Xray-core 实现双向网络地址转换（NAT）功能，以便通过零信任网络实现具有冲突 IP 地址的站点之间的连接。

## 问题陈述

两个站点（A 和 B）需要建立网络连接，但其 IP 地址范围重叠且无法修改：

- **站点 A**：网关 IP `192.168.1.1/24`，零信任 IP `10.10.10.10/24`
- **站点 B**：网关 IP `192.168.1.1/24`，零信任 IP `10.20.20.20/24`

目标是在不修改设备配置的情况下，使站点 A 的 `192.168.1.20` 能够与站点 B 的 `192.168.1.20` 进行通信。

## 解决方案

### 虚拟 IP 地址分配

- **站点 A 虚拟 IP**：`240.1.1.1/24` 和 `64:FF9B:1111::/96`
- **站点 B 虚拟 IP**：`240.2.2.2/24` 和 `64:FF9B:2222::/96`

### 核心架构

1.  **站点 A 路由器**：智能路由器，将发往站点 B 虚拟 IP 的流量通过零信任隧道进行引导
2.  **站点 B 路由器**：双向 NAT 网关，执行 DNAT（目标地址转换）和 SNAT（源地址转换）
3.  **虚拟 IP 层**：中性地址空间，用于解耦重叠的物理网络

## 关键组件

### 1. NAT 代理处理器

- **位置**：`proxy/nat/`
- **目的**：实现带会话跟踪的 DNAT/SNAT 转换
- **主要特性**：
  - 双向地址转换
  - 带超时清理的会话状态管理
  - 支持 IPv4 和 IPv6 虚拟 IP 范围

### 2. 增强的路由器配置

- **位置**：`app/router/`
- **目的**：添加 NAT 特定的路由规则和虚拟 IP 匹配
- **主要特性**：
  - 虚拟 IP 目标匹配
  - NAT 规则优先于标准路由
  - 基于站点的 NAT 策略管理

### 3. 会话上下文扩展

- **位置**：`common/session/`
- **目的**：向连接会话添加 NAT 特定的元数据
- **主要特性**：
  - 保留原始/源地址
  - 虚拟/真实地址映射
  - NAT 模式检测和跟踪

### 4. 配置模式

- **位置**：`infra/conf/`
- **目的**：定义 NAT 配置结构
- **主要特性**：
  - 虚拟 IP 范围定义
  - NAT 路由规则规范
  - 站点标识符和关联

## 依赖关系

- Xray-core 路由基础设施
- 零信任网络连接（假设已存在）
- 当前会话管理系统
- 现有代理处理器框架

## 变更影响

这是一个**破坏性变更**，需要：

1.  新的代理处理器类型
2.  扩展的路由器配置模式
3.  增强的会话上下文结构
4.  额外的路由条件匹配器

## 验证方案

1.  针对 NAT 转换逻辑的单元测试
2.  与现有路由系统的集成测试
3.  端到端连接性验证
4.  并发会话的性能测试

## 成功标准

- ✅ 站点 A 设备 `192.168.1.20` 可以使用虚拟 IP 与站点 B 设备 `192.168.1.20` 通信
- ✅ 双向 NAT 正确维护会话状态
- ✅ 终端设备无需修改
- ✅ 性能影响在可接受范围内
- ✅ 支持 IPv4 和 IPv6 虚拟 IP
- ✅ 优雅的错误处理和回退

## 风险与缓解措施

### 风险 1：会话表耗尽

- **缓解措施**：实施积极的超时清理和内存限制

### 风险 2：性能下降

- **缓解措施**：优化查找算法并考虑连接池

### 风险 3：复杂的状态管理

- **缓解措施**：设计清晰的状态生命周期和适当的清理机制

### 风险 4：路由复杂性

- **缓解措施**：保持 NAT 和标准路由之间的清晰分离

## 未来考虑

- 支持动态 NAT（基于 DHCP 的虚拟 IP 分配）
- 多站点互操作性（超过两个站点）
- 针对其他协议的 NAT 穿透
- 与现有企业 NAT 解决方案集成

---

**审批：**

- [ ] 架构评审
- [ ] 安全评审
- [ ] 性能评审
- [ ] 产品负责人批准

**变更 ID**：`implement-bidirectional-nat`

# 实施任务：双向 NAT

## 第一阶段：核心 NAT 代理处理器（第 1-2 周）

### 1.1 创建 NAT 代理处理器结构

- [ ] 创建 `proxy/nat/` 目录结构
- [ ] 实现 `nat.go` 及其基本处理器结构
- [ ] 将 NAT 处理器添加到 `main/distro/all/all.go` 的注册中
- [ ] 创建 `nat_test.go` 并编写单元测试

### 1.2 实现 NAT 会话管理

- [ ] 设计包含关键字段的会话数据结构
- [ ] 实现支持线程安全操作的并发会话表
- [ ] 添加会话创建、查找和清理函数
- [ ] 实现 LRU（最近最少使用）淘汰策略和内存限制

### 1.3 实现 DNAT（目标地址转换）转换逻辑

- [ ] 创建目标地址转换算法
- [ ] 如果指定，则添加端口映射支持
- [ ] 实现 IPv4 到 IPv4 的地址映射
- [ ] 添加 IPv6 虚拟地址到 IPv4 真实地址的映射

### 1.4 实现 SNAT（源地址转换）转换逻辑

- [ ] 创建源地址转换算法
- [ ] 实现返回流量的映射
- [ ] 为双向流添加基于会话的 SNAT
- [ ] 处理 TCP 和 UDP 协议的差异

## 第二阶段：配置与 Protobuf（第 2-3 周）

### 2.1 定义 NAT 配置 Protobuf

- [ ] 创建 `proxy/nat/config.proto` 文件，定义 NATConfig 消息
- [ ] 添加 VirtualIPRange、NATRule 及支持的消息类型
- [ ] 包含 SessionTimeout 和 ResourceLimits 消息
- [ ] 生成 Go protobuf 文件

### 2.2 实现配置解析

- [ ] 创建 `proxy/nat/config.go` 文件，实现配置解析逻辑
- [ ] 添加对虚拟 IP 范围和规则的验证
- [ ] 实现默认配置值
- [ ] 为无效配置添加错误处理

### 2.3 与核心配置系统集成

- [ ] 修改 `infra/conf/` 以支持 NAT 出站配置
- [ ] 添加 NAT 设置的 JSON 配置解析
- [ ] 更新配置文档
- [ ] 添加配置验证测试

### 2.4 实现 NAT 规则引擎

- [ ] 创建虚拟 IP 的规则匹配算法
- [ ] 添加基于协议和端口的过滤
- [ ] 实现基于站点的规则选择
- [ ] 添加规则优先级处理

## 第三阶段：路由器集成（第 3-4 周）

### 3.1 扩展路由器条件

- [ ] 将 VirtualIPMatcher 添加到 `app/router/condition.go`
- [ ] 实现 SiteID 匹配功能
- [ ] 添加 NAT 特定的条件评估
- [ ] 更新条件构建器以支持 NAT 类型

### 3.2 增强路由器配置

- [ ] 将 NAT 规则支持添加到路由器配置 protobuf
- [ ] 修改 `app/router/router.go` 以处理 NAT 规则
- [ ] 实现 NAT 规则优先级逻辑
- [ ] 添加 NAT 规则评估统计

### 3.3 更新调度器集成

- [ ] 修改 `app/dispatcher/default.go` 以进行 NAT 处理器选择
- [ ] 为 NAT 会话添加上下文保留
- [ ] 实现适当的错误传播
- [ ] 添加调度器级别的 NAT 指标

### 3.4 扩展会话上下文

- [ ] 将 NAT 元数据字段添加到会话上下文
- [ ] 修改 `common/session/session.go` 添加 NAT 字段
- [ ] 实现 NAT 模式检测和跟踪
- [ ] 添加基于上下文的 NAT 信息检索

## 第四阶段：集成与测试（第 4-5 周）

### 4.1 单元测试实现

- [ ] 测试 NAT 会话生命周期管理
- [ ] 验证 DNAT/SNAT 转换的正确性
- [ ] 测试配置解析和验证
- [ ] 验证规则匹配和路由逻辑

### 4.2 集成测试

- [ ] 为端到端 NAT 流程创建测试场景
- [ ] 测试虚拟 IP 之间的双向连接性
- [ ] 验证会话跟踪和清理
- [ ] 测试资源限制执行

### 4.3 性能测试

- [ ] 测量 NAT 转换开销
- [ ] 测试并发会话处理能力
- [ ] 验证负载下的内存使用情况
- [ ] 对会话查找性能进行基准测试

### 4.4 错误处理和健壮性

- [ ] 测试对无效数据包的优雅错误处理
- [ ] 验证资源压力下的行为
- [ ] 测试从网络故障中的恢复
- [ ] 实现适当的日志记录和监控

## 第五阶段：文档与部署（第 5-6 周）

### 5.1 配置文档

- [ ] 创建全面的 NAT 配置指南
- [ ] 为常见场景添加示例配置
- [ ] 记录虚拟 IP 分配策略
- [ ] 为常见问题创建故障排除指南

### 5.2 与文档集成

- [ ] 使用 NAT 功能更新 Xray 文档
- [ ] 将 NAT 添加到协议规范中
- [ ] 创建用例示例和教程
- [ ] 记录性能考虑因素和限制

### 5.3 性能优化

- [ ] 分析和优化会话表操作
- [ ] 在适用的地方实现连接池
- [ ] 优化内存分配模式
- [ ] 添加性能监控指标

### 5.4 安全性验证

- [ ] 对 NAT 实施进行安全审查
- [ ] 测试潜在的会话劫持漏洞
- [ ] 验证地址欺骗保护
- [ ] 实施额外的安全加固措施

## 第六阶段：最终测试与发布（第 6 周）

### 6.1 端到端验证

- [ ] 测试完整场景：站点 A 到站点 B 的连接性
- [ ] 验证 TCP 和 UDP 协议支持
- [ ] 测试 IPv4 和 IPv6 虚拟 IP 功能
- [ ] 验证零信任隧道集成

### 6.2 回归测试

- [ ] 使用 NAT 功能测试现有 Xray 功能
- [ ] 验证配置的向后兼容性
- [ ] 测试包含 NAT 和非 NAT 处理器的混合环境
- [ ] 验证对非 NAT 流量的性能影响

### 6.3 性能基准测试

- [ ] 测量吞吐量和延迟影响
- [ ] 测试增加会话数的可扩展性
- [ ] 验证内存使用模式
- [ ] 建立性能基线和 SLA

### 6.4 发布准备

- [ ] 最终代码审查和清理
- [ ] 更新 CHANGELOG 和发布说明
- [ ] 为现有用户准备迁移指南
- [ ] 为 NAT 相关错误创建问题跟踪模板

## 任务依赖关系

### 关键依赖

- 任务 1.2（会话管理）必须在任务 1.3（DNAT）和 1.4（SNAT）之前完成
- 任务 2.1（Protobuf 定义）必须在任务 2.2（配置解析）之前完成
- 任务 3.1（路由器条件）必须在任务 3.2（路由器配置）之前完成

### 并行执行机会

- 第一阶段的任务可以部分并行化（在开发会话逻辑的同时构建基本结构）
- 单元测试（4.1）可以与实施同时开发
- 文档（5.1）可以在功能仍在实施时开始

### 阻塞因素与风险

- **风险**：高负载下会话表的性能问题
  - **缓解措施**：尽早实现高效的查找结构
- **风险**：双向 NAT 中复杂的状态管理
  - **缓解措施**：实施彻底的状态生命周期测试
- **风险**：与现有路由器的集成复杂性
  - **缓解措施**：通过频繁测试进行增量集成

## 验证指标

### 成功标准

- [ ] 站点 A 的设备 (192.168.1.20) 能够通过虚拟 IP 连接到站点 B 的设备
      (192.168.1.20)
- [ ] TCP 和 UDP 的双向流量均能正常工作
- [ ] 会话表能处理 10,000+ 个并发会话
- [ ] 内存使用保持在配置限制内
- [ ] 对非 NAT 流量的性能影响 < 5%
- [ ] IPv4 和 IPv6 虚拟 IP 支持完全正常
- [ ] 所有单元测试和集成测试通过
- [ ] 配置验证能防止常见的错误配置

### 质量门禁

- **代码覆盖率**：新增 NAT 代码的覆盖率最低为 80%
- **性能**：在 10,000 个会话下，会话查找延迟 < 1ms
- **内存**：每个会话的内存使用量 < 2KB
- **可靠性**：正常负载下会话成功率为 99.9%
- **安全性**：安全审查中未报告安全漏洞
